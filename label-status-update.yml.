name: Update Issue Labels Based on Project Status

on:
  workflow_dispatch: # permite execução manual
  issues:
    types: [opened, edited]

jobs:
  update_labels:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Get issue details
        id: issue_data
        uses: actions-ecosystem/action-get-issue@v1
        with:
          issue_number: ${{ github.event.issue.number }}
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}

      - name: Update label based on project status
        run: |
          STATUS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/projects/columns/${{ github.event.issue.project_column_id }} | jq -r '.name')

          case $STATUS in
            "Todo")
              NEW_LABEL="Todo"
              ;;
            "In Progress")
              NEW_LABEL="In Progress"
              ;;
            "Done")
              NEW_LABEL="Done"
              ;;
            *)
              echo "Status desconhecido: $STATUS"
              exit 1
              ;;
          esac

          # Remover labels de status anteriores
          EXISTING_LABELS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/issues/${{ github.event.issue.number }}/labels | jq -r '.[] | select(.name == "Todo" or .name == "In Progress" or .name == "Done").name')

          for label in $EXISTING_LABELS; do
            curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/issues/${{ github.event.issue.number }}/labels/$label
          done

          # Adicionar nova label
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d '{"labels":["'$NEW_LABEL'"]}' \
            https://api.github.com/repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/issues/${{ github.event.issue.number }}/labels
